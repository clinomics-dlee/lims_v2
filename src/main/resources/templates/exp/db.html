<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<th:block th:replace="layout/head"></th:block>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.14.3/xlsx.full.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
</head>
<body class="pace-done">
	<!-- begin #page-loader -->
	<div id="page-loader" class="fade show">
		<div class="material-loader">
			<svg class="circular" viewBox="25 25 50 50">
				<circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10"></circle>
			</svg>
			<div class="message">Loading</div>
		</div>
	</div>
	<!-- end #page-loader -->
	
	<!-- begin #page-container -->
	<div id="page-container" class="fade page-sidebar-fixed page-header-fixed">
		<!-- begin #header -->
		<th:block th:replace="layout/top"></th:block>
		<!-- end #header -->
		<!-- begin #sidebar -->
		<th:block th:replace="layout/left"></th:block>
		<!-- end #sidebar -->
		<th:block th:replace="popup/mapping_sample"></th:block>
		<!-- begin #content -->
		<div id="content" class="content">
			<!-- begin page header -->
			<ol class="breadcrumb float-xl-right">
				<li class="breadcrumb-item">Home</li>
				<li class="breadcrumb-item">실험</li>
				<li class="breadcrumb-item active">실험DB</li>
			</ol>
			
			<h1 id="page-header" class="page-header">실험 - 실험DB</h1>
			<!-- end page-header -->
			
			<!-- begin content panel -->
			<div class="row">
				<div class="col-xl-12">
					<ul class="nav nav-tabs">
						<li class="nav-item">
							<a href="#db-tab-1" data-toggle="tab" class="nav-link active">
								<span class="d-sm-none">Tab 1</span>
								<span class="d-sm-block d-none">실험 DB</span>
							</a>
						</li>
						<li class="nav-item">
							<a href="#db-tab-2" data-toggle="tab" class="nav-link">
								<span class="d-sm-none">Tab 2</span>
								<span class="d-sm-block d-none">Mapping DB</span>
							</a>
						</li>
					</ul>
					
					<!-- begin tab content -->
					<div class="tab-content">
						<!-- begin tab-1 -->
						<div class="tab-pane fade active show" id="db-tab-1">
							<div class="form-group row m-b-12">
								<label class="col-form-label col-md-1">서비스</label>
								<div>
									<select class="form-control width-200" data-parsley-required="true" id="sel_bundle" name="bundleId">
										<option value="">All</option>
										<option th:each="bnd : ${bundles}" th:value="${bnd.getId()}" th:text="${bnd.getName()}"></option>
									</select>
								</div>
								<div class="input-group" id="default-daterange" style="width: auto; float: right; padding-left: 10px; min-width: 250px" >
								    <input type="text" name="default-daterange" class="form-control" value="" placeholder="click to select the date range" readonly="readonly"/>
								    <span class="input-group-append">
								    	<span class="input-group-text"><i class="fa fa-calendar"></i></span>
									</span>
								</div>
								<label class="col-form-label col-md-1">검색어</label>
								<div class="col-xs-push-0">
								    <input type="text" id="keyword" class="form-control"/>
								</div>
								<div>
									<button onClick="search();" class="btn btn-default m-l-10">검색</button>
								</div>
							</div>
							<hr/>
							<div id="_sample_db_grid"></div>
							<hr/>
							<div class="row">
								<button onClick="downloadExcel();" class="btn btn-success m-l-20">Excel Download</button>
							</div>
						</div>
						<!-- end tab-1 -->

						<!-- begin tab-2 -->
						<div class="tab-pane fade" id="db-tab-2">
							<div class="form-group row m-b-12">
								<label class="col-form-label col-md-1">검색어</label>
								<div class="col-xs-push-0">
								    <input type="text" id="keywordMapping" class="form-control"/>
								</div>
								<div>
									<button onClick="searchMapping();" class="btn btn-default m-l-10">검색</button>
								</div>
							</div>
							<hr/>
							<div id="_mapping_db_grid"></div>
							<hr/>
							<div class="row">
								<button onClick="downloadExcelMapping();" class="btn btn-success m-l-20">Excel Download</button>
							</div>
						</div>
						<!-- end tab-2 -->
					</div>
					<!-- end tab content -->
				</div>
			</div>
			<!-- end content panel -->
		</div>
		
		<!-- end #content -->
		<!-- begin scroll to top btn -->
		<!-- end scroll to top btn -->
	</div>
	<!-- end page container -->
	
	
	<script th:inline="javascript">
	/* <![CDATA[ */

	var g_statusCodeInfo = /*[[${statusCodes}]]*/ {};
	var g_genotypingMethodCodeInfo = /*[[${genotypingMethodCodes}]]*/ {};
	var g_chipTypeCodeInfo = /*[[${chipTypeCodes}]]*/ {};
	
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	
	//  시작
	$(document).ready(function() {
		App.init();
		
		$('#sel_bundle').on('change', function () {
			//search();
		});
		
		$("#keyword").keydown(function(key) {
			if (key.keyCode == 13) {
				search();
			}
		});

		$("#keywordMapping").keydown(function(key) {
			if (key.keyCode == 13) {
				searchMapping();
			}
		});
		
		//set search date
		$('#default-daterange').daterangepicker({
			opens: 'left',
			format : 'YYYY/MM/DD',
			separator: ' to ',
			startDate: moment().subtract(1, 'months'),
			endDate: moment(),
			minDate: '2018/01/01',
			maxDate: moment(),
		}, function (start, end) {
			
			$('#startDate').val(start.format('YYYY-MM-DD'));
			$('#finishDate').val(end.format('YYYY-MM-DD'));
			$('#default-daterange input').val(start.format('YYYY-MM-DD') + ' ~ ' + end.format('YYYY-MM-DD'));
			
		});
		startDate = moment().subtract(1, 'months');
		endDate = moment();
		$('#default-daterange input').val(startDate.format('YYYY-MM-DD') + ' ~ ' + endDate.format('YYYY-MM-DD'));
		$('#startDate').val(startDate.format('YYYY-MM-DD'));
		$('#finishDate').val(endDate.format('YYYY-MM-DD'));
		
		UserTable.init('_sample_db_grid', true, [10, 50] , [10, 50]);
		drawSampleDbGrid();

		UserTable.init('_mapping_db_grid', true, [10, 50] , [10, 50]);
		drawMappingGrid();
	});
	
	function drawSampleDbGrid() {
		UserTable.draw('_sample_db_grid', {
			url : "/exp/db/sample/get",
			type : "GET",
			data : function() {
				var param = {
					bundleId : $("#sel_bundle").val(),
					sDate : $('#startDate').val() == "" || $('#startDate').val() == null ? "" : $('#startDate').val(),
					fDate : $('#finishDate').val() == "" || $('#finishDate').val() == null ? "" : $('#finishDate').val(),
					keyword : $("#keyword").val()
				};
				return param;
			},
			beforeSend : function(xhr) {
				xhr.setRequestHeader(header, token);
			}
		}, [{
			title : ' ',
			data : "id",
			headClassName : 'width-50',
			bodyClassName : 'text-center',
			type : {
				name : "checkbox"
			}
		}, {
			title : 'No', 
			data : 'id',
			headClassName : 'width-50',
			bodyClassName : 'text-center',
			render : function(row, data, index) {
				return '<string>' + (index + 1) + '</string>';
			}
		}, {
			title : "서비스",
			data : "bundle.name"
		}, {
			title : "검사실 ID",
			data : "laboratoryId"
		}, {
			title : "Genotyping ID",
			data : "laboratoryId",
			render : function(row, data, index) {
				return data + '-V' + row.version;
			}
		}, {
			title : "Genotyping Method",
			data : "genotypingMethodCode",
			render : function(row, data, index) {
				var value = "";
				if (data != null && data.length > 0) {
					value = g_genotypingMethodCodeInfo[data];
				}
				return value;
			}
		}, {
			title : "검체종류",
			data : "items.sampleType"
		}, {
			title : "검체 채취일",
			data : "items.sampleCollected"
		}, {
			title : "상태",
			data : "statusCode",
			render : function(row, data, index) {
				var value = g_statusCodeInfo[data];
				return value;
			}
		}, {
			serverHeader : true
		}, {
			title : "검체 입고일",
			data : "createdDate",
			type : "date"
		}, {
			title : "A 260/280",
			data : "a260280"
		}, {
			title : "농도 (ng/μL)",
			data : "cncnt"
		}, {
			title : "DNA QC",
			data : "dnaQc"
		}]);
	}
	
	function search() {
		UserTable.reload('_sample_db_grid');
	}

	function drawMappingGrid() {
		UserTable.draw('_mapping_db_grid', {
			url : "/exp/db/mapping/get",
			type : "GET",
			data : function() {
				var param = {
					keyword : $("#keywordMapping").val()
				};
				return param;
			},
			beforeSend : function(xhr) {
				xhr.setRequestHeader(header, token);
			}
		}, [{
			title : ' ',
			data : "id",
			headClassName : 'width-50',
			bodyClassName : 'text-center',
			type : {
				name : "checkbox"
			}
		}, {
			title : 'No', 
			data : 'id',
			headClassName : 'width-50',
			bodyClassName : 'text-center',
			render : function(row, data, index) {
				return '<string>' + (index + 1) + '</string>';
			}
		}, {
			title : "Mapping No",
			data : "mappingNo",
			render : function(row, data, index) {
				return '<a href="javascript:mappingSamplePopupOnload(\'' + data + '\')">' + data + '</a>';
			}
		}, {
			title : "Chip Barcode",
			data : "chipBarcode"
		}, {
			title : "Chip Type",
			data : "chipTypeCode",
			headClassName : 'width-300',
			render : function(row, data, index) {
				var value = '';
				if (data != null && data.length > 0) {
					value = g_chipTypeCodeInfo[data];
				}
				return value;
			}
		}]);
	}

	function searchMapping() {
		UserTable.reload('_mapping_db_grid');
	}

	function s2ab(s) { 
		var buf = new ArrayBuffer(s.length); //convert s to arrayBuffer
		var view = new Uint8Array(buf);  //create uint8array as viewer
		for (var i=0; i<s.length; i++) view[i] = s.charCodeAt(i) & 0xFF; //convert to octet
		return buf;    
	}
	
	function downloadExcel() {
		var rows = UserTable.getRows("_sample_db_grid");
		if (rows.length > 0) {
			// step 1. workbook 생성
			var wb = XLSX.utils.book_new();
			// step 2. 시트 만들기 
			var newWorksheet = XLSX.utils.json_to_sheet(rows);
			// var newWorksheet = XLSX.utils.table_to_sheet(document.getElementById('_sample_db_grid_table'));
			// step 3. workbook에 새로만든 워크시트에 이름을 주고 붙인다.  
			XLSX.utils.book_append_sheet(wb, newWorksheet, "sheet1");
			// step 4. 엑셀 파일 만들기 
			var wbout = XLSX.write(wb, {bookType:'xlsx',  type: 'binary'});
			// step 5. 엑셀 파일 내보내기 
			saveAs(new Blob([s2ab(wbout)], {type:"application/octet-stream"}), "Sample.xlsx");
		}
	}

	/* ]]> */
	</script>
	
	<input type="hidden" name="startDate" id="startDate" value="" />
	<input type="hidden" name="finishDate" id="finishDate" value="" />

</body>
</html>